<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>smallcoderofme</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 mb-3">
            <nav class="navbar navbar-expand-lg navbar-light bg-primary p-4">
            <span class="navbar-brand offset-md-2 uppercase font-weight-bold">smallcoderofme
            </span>
                <button class="navbar-toggler" type="button"
                        data-toggle="collapse"
                        data-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent"
                        aria-expanded="false"
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-center" id="navbarSupportedContent">
                    <ul class="nav navbar-nav font-weight-bold">
                        <li class="nav-item nav-size">
                            <a class="nav-link text-dark" href="../index.html">主页</a>
                        </li>
                        <li class="nav-item nav-size">
                            <a class="nav-link text-dark" href="../blog.html">博客</a>
                        </li>
                        <li class="nav-item nav-size">
                            <a class="nav-link text-dark" href="../bookmark.html">收藏</a>
                        </li>
                        <li class="nav-item nav-size">
                            <a class="nav-link text-dark" href="#">About</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="col-md-3"></div>
        <div class="col-md-6">
            <div class="h3 text-center title border-bottom">Nodejs 搭建简易文件服务</div>
            <p class="h5 ">项目依赖的js库安装</p>
<pre class="h6 code"> <code class="javascript">
'use strict';

//加载所需要的模块
const http = require('http');
const url = require('url');
const fs = require('fs');
const path = require('path');
const cp = require('child_process');

//创建服务
const httpServer = http.createServer(processRequest);

const port = 8000;

//指定一个监听的接口
httpServer.listen(port, function() {
    console.log(`server is running at port:${port}`);
});

//响应请求的函数
function processRequest (request, response) {
    //mime类型
    var mime = {
    	'jpg': 'image/jpeg',
		'jpeg': 'image/jpeg',
		'gif': 'image/gif',
		'png': 'image/png',
		'svg': 'image/svg+xml',
		'mp3': 'audio/mpeg',
		'wav': 'audio/wav',
		'ogg': 'audio/ogg',
		'webm': 'audio/webm'
                // "css": "text/css",
                // "gif": "image/gif",
                // "html": "text/html",
                // "ico": "image/x-icon",
                // "jpeg": "image/jpeg",
                // "jpg": "image/jpeg",
                // "js": "text/javascript",
                // "json": "application/json",
                // "pdf": "application/pdf",
                // "png": "image/png",
                // "svg": "image/svg+xml",
                // "swf": "application/x-shockwave-flash",
                // "tiff": "image/tiff",
                // "txt": "text/plain",
                // "wav": "audio/x-wav",
                // "wma": "audio/x-ms-wma",
                // "wmv": "video/x-ms-wmv",
                // "xml": "text/xml"
    };

    //request里面切出标识符字符串
    var requestUrl = request.url;
    //url模块的parse方法 接受一个字符串，返回一个url对象,切出来路径
    var pathName = url.parse(requestUrl).pathname;

    //对路径解码，防止中文乱码
    var pathName = decodeURI(pathName);

    //解决301重定向问题，如果pathname没以/结尾，并且没有扩展名
    if (!pathName.endsWith('/') && path.extname(pathName) === '') {
        pathName += '/';
        var redirect = "http://" + request.headers.host + pathName;
        response.writeHead(301, {
            location: redirect
        });
        response.end();
    }

    //获取资源文件的绝对路径
    var filePath = path.resolve(__dirname + pathName);
    // console.log(pathName);
    //获取对应文件的文档类型
    //我们通过path.extname来获取文件的后缀名。由于extname返回值包含”.”，所以通过slice方法来剔除掉”.”，
    //对于没有后缀名的文件，我们一律认为是unknown。
    var ext = path.extname(pathName);
    ext = ext ? ext.slice(1) : 'unknown';

    //未知的类型一律用"text/plain"类型
    var contentType = mime[ext] || "text/plain";

    fs.stat(filePath, (err, stats) => {
        if (err) {
            response.writeHead(404, { "content-type": "text/html" });
            response.end("< h1>404 Not Found< /h1 >");
        }
        //没出错 并且文件存在
        if (!err && stats.isFile()) {
            readFile(filePath, contentType);
        }
        //如果路径是目录
        if (!err && stats.isDirectory()) {
            let html = "< head>< meta charset = 'utf-8'/>< /head>< body>< h1>403 Forbiden< /h1>< /body>";
            response.writeHead(200, { "content-type": "text/html" });
            response.end(html);
        }

        //读取文件的函数
        function readFile(filePath, contentType){
            response.writeHead(200, { "content-type": contentType });
            //建立流对象，读文件
            let stream = fs.createReadStream(filePath);
            //错误处理
            stream.on('error', function() {
            response.writeHead(500, { "content-type": contentType });
            response.end('< h1>500 Server Error< /h1>');
        });
            //读取文件
            stream.pipe(response);
        }
    });
}</code>
</pre>
        <div class="col-md-3"></div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/highlight.min.js"></script>
</body>
</html>